{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"_\"","src://tavern_helper_template/src/下拉选项大修/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = _;","import { debounce } from 'lodash';\n\n/* eslint-disable better-tailwindcss/no-duplicate-classes */\n//const REPLACED_MARKER = 'k3rn-replaced';\nconst ACTIVE_CLASS = 'k3rn-trigger-active';\nconst DROPDOWN_ID = 'k3rn-global-dropdown';\nconst STYLE_ID = `k3rn-select-style`;\nconst SCROLL_NAMESPACE = 'k3rn-scroll';\n\nconst SEARCH_THRESHOLD = 7; // 7是完美的数字哦 阿门\n\n// 1. 样式定义\nconst styles = `\n  #${DROPDOWN_ID} {\n      margin: 0;\n      position: fixed;\n      z-index: 99999;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.4);\n      max-height: 400px;\n      display: flex;\n      flex-direction: column;\n      background: var(--SmartThemeBlurTintColor, #1a1a1a);\n      color: var(--SmartThemeBodyColor, #eee);\n      border: 1px solid var(--SmartThemeBorderColor, #444);\n      border-radius: 4px;\n      font-size: 14px;\n      overflow: hidden;\n      backdrop-filter: blur(8px);\n      -webkit-backdrop-filter: blur(8px);\n  }\n\n  #${DROPDOWN_ID} .search-wrapper {\n      padding: 8px;\n      background: rgba(0, 0, 0, 0.2);\n      border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n      flex-shrink: 0;\n  }\n\n  #${DROPDOWN_ID} .search-input {\n      width: 100%;\n      padding: 6px 8px;\n      border-radius: 4px;\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      background: rgba(0, 0, 0, 0.3);\n      color: inherit;\n      outline: none;\n      font-size: 13px;\n  }\n  #${DROPDOWN_ID} .search-input:focus {\n      border-color: var(--SmartThemeQuoteColor, #888);\n      background: rgba(0, 0, 0, 0.5);\n  }\n\n  #${DROPDOWN_ID} .options-list {\n      overflow-y: auto;\n      flex-grow: 1;\n      max-height: 300px;\n  }\n\n  #${DROPDOWN_ID} .options-list::-webkit-scrollbar {\n      width: 6px;\n  }\n  #${DROPDOWN_ID} .options-list::-webkit-scrollbar-thumb {\n      background: rgba(255, 255, 255, 0.2);\n      border-radius: 3px;\n  }\n\n  #${DROPDOWN_ID} .option-item {\n      padding: 8px 12px;\n      cursor: pointer;\n      transition: background 0.1s;\n  }\n  #${DROPDOWN_ID} .option-item:hover {\n      background: rgba(255,255,255,0.1);\n  }\n  #${DROPDOWN_ID} .option-item.selected {\n      background: rgba(255,255,255,0.15);\n      font-weight: bold;\n      border-left: 3px solid var(--SmartThemeQuoteColor, #888);\n  }\n  #${DROPDOWN_ID} .no-results {\n      padding: 12px;\n      text-align: center;\n      color: var(--SmartThemeBodyColor, #eee);\n      font-style: italic;\n      display: none;\n  }\n`;\n\nconst injectGlobalStyles = () => {\n  $(`#${STYLE_ID}`).remove();\n  $(`<style id=\"${STYLE_ID}\">${styles}</style>`).appendTo('head');\n};\n\nconst closeDropdown = () => {\n  const $activeSelect = $(`.${ACTIVE_CLASS}`);\n  if ($activeSelect.length) {\n    $activeSelect.parents().add(document).off(`.${SCROLL_NAMESPACE}`);\n    $activeSelect.removeClass(ACTIVE_CLASS);\n  }\n  $(`#${DROPDOWN_ID}`).remove();\n};\n\nconst isMobile = () => window.innerWidth <= 768;\n\nconst openDropdown = ($select: JQuery<HTMLElement>) => {\n  $select.addClass(ACTIVE_CLASS);\n\n  const $parents = $select.parents().add(document);\n  $parents.on(`scroll.${SCROLL_NAMESPACE}`, () => {\n    closeDropdown();\n  });\n\n  const options = $select.find('option');\n  const items: JQuery<HTMLElement>[] = [];\n\n  // 1. 先构建选项列表，以便准确计算有效选项的数量\n  options.each((_: number, opt: HTMLElement) => {\n    const $opt = $(opt);\n    if ($opt.css('display') === 'none') return;\n\n    const text = $opt.text();\n    const isSelected = $opt.is(':selected');\n    const $item = $(`<div class=\"option-item ${isSelected ? 'selected' : ''}\">${text}</div>`);\n\n    $item.data('search-text', text.toLowerCase());\n\n    $item.on('click', e => {\n      e.stopPropagation();\n\n      const value = $opt.val() ?? 'undefined';\n\n      const nativeSelect = $select[0] as HTMLSelectElement; //这里采用native\n\n      nativeSelect.value = value.toString();\n\n      nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));\n      nativeSelect.dispatchEvent(new Event('input', { bubbles: true }));\n      $select.trigger('change');\n      $opt.trigger('click');\n\n      closeDropdown();\n    });\n    $item.on('mousedown touchstart touchend', e => e.stopPropagation());\n\n    items.push($item);\n  });\n\n  // 2. 根据选项数量判断是否需要渲染搜索框\n  const search = items.length > SEARCH_THRESHOLD;\n\n  const $dropdown = $(`<div id=\"${DROPDOWN_ID}\"></div>`);\n  const $optionsList = $(`<div class=\"options-list\"></div>`);\n  const $noResults = $(`<div class=\"no-results\">无结果</div>`);\n\n  let $searchInput: JQuery<HTMLElement> | undefined;\n\n  // 3. 条件组装 DOM 结构\n  if (search) {\n    const $searchWrapper = $(\n      `<div class=\"search-wrapper\"><input type=\"text\" class=\"search-input\" placeholder=\"搜索…\" /></div>`,\n    );\n    $searchInput = $searchWrapper.find('input');\n\n    // 搜索过滤逻辑 (仅在有搜索框时绑定)\n    $searchInput.on(\n      'input',\n      debounce((e: any) => {\n        const val = e.target.value.toLowerCase().trim();\n        let somethingsHere = false;\n\n        items.forEach($item => {\n          const itemText = $item.data('search-text');\n          if (!val || itemText.includes(val)) {\n            $item.css('display', '');\n            somethingsHere = true;\n          } else {\n            $item.css('display', 'none');\n          }\n        });\n\n        if (somethingsHere) {\n          $noResults.hide();\n        } else {\n          $noResults.show();\n        }\n      }, 200),\n    );\n\n    $searchInput.on('mousedown click touchstart touchend', e => e.stopPropagation());\n    $dropdown.append($searchWrapper);\n  }\n\n  $optionsList.append(items).append($noResults);\n  $dropdown.append($optionsList);\n  //$('body').append($dropdown);\n\n  const $closestDialog = $select.closest('dialog');\n  if ($closestDialog.length) {\n    $closestDialog.append($dropdown);\n  } else {\n    $('body').append($dropdown);\n  }\n\n  // 4. 定位计算\n  const rect = $select[0].getBoundingClientRect();\n  const scrollTop = $(window).scrollTop() || 0;\n  const scrollLeft = $(window).scrollLeft() || 0;\n  const windowHeight = $(window).height() || 0;\n\n  const estimatedMaxHeight = 350;\n  const spaceBelow = windowHeight - rect.bottom;\n\n  let top = 0;\n  if (spaceBelow < estimatedMaxHeight && rect.top > estimatedMaxHeight) {\n    const actualHeight = $dropdown.outerHeight() ?? 300;\n    top = rect.top + scrollTop - actualHeight - 4;\n  } else {\n    top = rect.bottom + scrollTop + 4;\n  }\n\n  const left = Math.max(4, rect.left + scrollLeft);\n\n  $dropdown.css({\n    top: top + 'px',\n    left: left + 'px',\n    minWidth: Math.max(rect.width, 200) + 'px',\n  });\n\n  // 5. 自动聚焦与滚动定位\n  setTimeout(() => {\n    // 只有在非移动端且启用了搜索框的情况下才去聚焦\n    if (!isMobile() && $searchInput) {\n      $searchInput.trigger('focus');\n    }\n\n    // 无论有没有搜索框，都保持滚动到选中项的逻辑\n    const $selectedItem = $optionsList.find('.selected');\n    if ($selectedItem.length) {\n      $optionsList.scrollTop($selectedItem[0].offsetTop - $optionsList.height()! / 2);\n    }\n  }, 2);\n};\n\n// const processSelects = () => {\n//   // 注意：如果脚本和DOM不在同一个window，请使用 $(window.parent.document).find(...)\n//   const $root = window.parent.document ? $(window.parent.document) : $(document);\n\n//   $root\n//     .find('select')\n//     .not(`[${REPLACED_MARKER}]`)\n//     .each(function () {\n//       const $select = $(this);\n//       $select.attr(REPLACED_MARKER, 'true');\n//       // 这里不再绑定 .on('mousedown')，交给全局委托处理\n//     });\n// };\n// 2. 新增一个处理触发逻辑的函数，用于事件委托\nconst handleSelectTrigger = (e: JQuery.TriggeredEvent) => {\n  // 确保是左键\n  if (e.button !== 0) return;\n  const target = e.currentTarget as HTMLElement;\n  const $select = $(target);\n  // 阻止原生菜单弹出\n  e.preventDefault();\n  e.stopPropagation(); // 防止冒泡给其他可能触发原生UI的脚本\n\n  // 聚焦（为了保持键盘操作连贯性）\n  target.focus();\n  const isActive = $select.hasClass(ACTIVE_CLASS);\n  if (isActive) {\n    closeDropdown();\n    return;\n  }\n  closeDropdown();\n  openDropdown($select);\n};\n// 3. 修改 init 函数，使用事件委托\nconst init = () => {\n  injectGlobalStyles();\n  //processSelects();\n  // 获取正确的上下文文档\n  const targetDoc = window.parent.document || document;\n  // === 核心修改：事件委托 ===\n  // 监听 targetDoc 下所有 select 的 mousedown 事件\n  // 这样即使 select 被销毁重建，只要它还是 select，就会触发这个处理函数\n  $(targetDoc).on('mousedown', 'select', handleSelectTrigger);\n\n  // 额外防御：同时阻止 click 事件的默认行为，防止漏网之鱼\n  $(targetDoc).on('click', 'select', e => {\n    // 如果不是我们的自定义下拉，或者为了确保原生不弹出\n    e.preventDefault();\n    // 如果 mousedown 没触发（极少见），可以在这里补救，但通常只需 preventDefault\n  });\n  // 键盘事件也可以委托\n  $(targetDoc).on('keydown', 'select', function (e) {\n    const $select = $(this);\n    if (e.key === ' ' || e.key === 'Enter') {\n      e.preventDefault();\n      e.stopPropagation();\n      const isActive = $select.hasClass(ACTIVE_CLASS);\n      closeDropdown();\n      if (!isActive) openDropdown($select);\n    }\n  });\n  // const observer = new MutationObserver(mutations => {\n  //   // 即使使用了委托，我们可能仍需运行 processSelects 来打标记或做初始化处理\n  //   // 但不再依赖它来绑定事件，所以不会有“僵尸属性”导致事件丢失的问题\n  //   //if (mutations.some(mut => mut.addedNodes.length > 0)) processSelects();\n  // });\n  // observer.observe(targetDoc, { childList: true, subtree: true });\n};\n\n$(() => {\n  init();\n\n  window.parent.document.addEventListener('click', e => {\n    if (!e.target) return;\n    if ((e.target as Element).closest('select')?.length ?? -1 > 0) return;\n    closeDropdown();\n  });\n});\n"],"names":["_","ACTIVE_CLASS","DROPDOWN_ID","STYLE_ID","SCROLL_NAMESPACE","styles","closeDropdown","$activeSelect","$","length","parents","add","document","off","removeClass","remove","openDropdown","$select","addClass","on","options","find","items","each","opt","$opt","css","text","isSelected","is","$item","data","toLowerCase","e","stopPropagation","value","val","nativeSelect","toString","dispatchEvent","Event","bubbles","trigger","push","search","$dropdown","$optionsList","$noResults","$searchInput","$searchWrapper","debounce","target","trim","somethingsHere","forEach","itemText","includes","hide","show","append","$closestDialog","closest","rect","getBoundingClientRect","scrollTop","window","scrollLeft","top","height","bottom","actualHeight","outerHeight","left","Math","max","minWidth","width","setTimeout","innerWidth","$selectedItem","offsetTop","handleSelectTrigger","button","currentTarget","preventDefault","focus","hasClass","init","appendTo","targetDoc","parent","this","key","isActive","addEventListener"],"sourceRoot":""}