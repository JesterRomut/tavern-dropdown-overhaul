{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"_\"","src://tavern_helper_template/src/下拉选项大修/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = _;","import { debounce } from 'lodash';\n\n/* eslint-disable better-tailwindcss/no-duplicate-classes */\nconst REPLACED_MARKER = 'k3rn-replaced';\nconst ACTIVE_CLASS = 'k3rn-trigger-active';\nconst DROPDOWN_ID = 'k3rn-global-dropdown';\nconst STYLE_ID = `k3rn-select-style`;\nconst SCROLL_NAMESPACE = 'k3rn-scroll';\n\n// 1. 样式定义\nconst styles = `\n  #${DROPDOWN_ID} {\n      position: absolute;\n      z-index: 99999;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.4);\n      max-height: 400px;\n      display: flex;\n      flex-direction: column;\n      background: var(--SmartThemeBlurTintColor, #1a1a1a);\n      color: var(--SmartThemeBodyColor, #eee);\n      border: 1px solid var(--SmartThemeBorderColor, #444);\n      border-radius: 4px;\n      font-size: 14px;\n      overflow: hidden;\n      backdrop-filter: blur(8px);\n      -webkit-backdrop-filter: blur(8px);\n  }\n\n  #${DROPDOWN_ID} .search-wrapper {\n      padding: 8px;\n      background: rgba(0, 0, 0, 0.2);\n      border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n      flex-shrink: 0;\n  }\n\n  #${DROPDOWN_ID} .search-input {\n      width: 100%;\n      padding: 6px 8px;\n      border-radius: 4px;\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      background: rgba(0, 0, 0, 0.3);\n      color: inherit;\n      outline: none;\n      font-size: 13px;\n  }\n  #${DROPDOWN_ID} .search-input:focus {\n      border-color: var(--SmartThemeQuoteColor, #888);\n      background: rgba(0, 0, 0, 0.5);\n  }\n\n  #${DROPDOWN_ID} .options-list {\n      overflow-y: auto;\n      flex-grow: 1;\n      max-height: 300px;\n  }\n\n  #${DROPDOWN_ID} .options-list::-webkit-scrollbar {\n      width: 6px;\n  }\n  #${DROPDOWN_ID} .options-list::-webkit-scrollbar-thumb {\n      background: rgba(255, 255, 255, 0.2);\n      border-radius: 3px;\n  }\n\n  #${DROPDOWN_ID} .option-item {\n      padding: 8px 12px;\n      cursor: pointer;\n      transition: background 0.1s;\n  }\n  #${DROPDOWN_ID} .option-item:hover {\n      background: rgba(255,255,255,0.1);\n  }\n  #${DROPDOWN_ID} .option-item.selected {\n      background: rgba(255,255,255,0.15);\n      font-weight: bold;\n      border-left: 3px solid var(--SmartThemeQuoteColor, #888);\n  }\n  #${DROPDOWN_ID} .no-results {\n      padding: 12px;\n      text-align: center;\n      color: var(--SmartThemeBodyColor, #eee);\n      font-style: italic;\n      display: none;\n  }\n`;\n\nconst injectGlobalStyles = () => {\n  $(`#${STYLE_ID}`).remove();\n  $(`<style id=\"${STYLE_ID}\">${styles}</style>`).appendTo('head');\n};\n\nconst closeDropdown = () => {\n  // 1. 先处理事件清理：找到当前激活的 select\n  const $activeSelect = $(`.${ACTIVE_CLASS}`);\n  if ($activeSelect.length) {\n    // 移除该 select 所有父级元素上的滚动监听，避免内存泄漏和不必要的触发\n    // add(window) 确保同时也移除了 window 上的监听\n    $activeSelect.parents().add(document).off(`.${SCROLL_NAMESPACE}`);\n    $activeSelect.removeClass(ACTIVE_CLASS);\n  }\n\n  // 2. 移除 DOM\n  $(`#${DROPDOWN_ID}`).remove();\n};\n\nconst processSelects = () => {\n  $('select')\n    .not(`[${REPLACED_MARKER}]`)\n    .each(function () {\n      const $select = $(this);\n      $select.attr(REPLACED_MARKER, 'true');\n\n      $select.on('mousedown', function (e) {\n        if (e.button !== 0) return;\n\n        e.preventDefault();\n        this.focus();\n\n        const isActive = $select.hasClass(ACTIVE_CLASS);\n\n        // 如果已经打开，再次点击则是关闭\n        if (isActive) {\n          closeDropdown();\n          return;\n        }\n\n        // 关闭其他可能存在的下拉\n        closeDropdown();\n\n        openDropdown($select);\n      });\n\n      $select.on('keydown', function (e) {\n        if (e.key === ' ' || e.key === 'Enter') {\n          e.preventDefault();\n          e.stopPropagation();\n          const isActive = $select.hasClass(ACTIVE_CLASS);\n          closeDropdown();\n          if (!isActive) openDropdown($select);\n        }\n      });\n    });\n};\n\nconst openDropdown = ($select: JQuery<HTMLElement>) => {\n  $select.addClass(ACTIVE_CLASS);\n\n  // 当父容器滚动时，下拉菜单位置会错位，因此需要关闭菜单\n  const $parents = $select.parents().add(document);\n  $parents.on(`scroll.${SCROLL_NAMESPACE}`, () => {\n    closeDropdown();\n  });\n  // ---------------------------\n\n  // 1. 构建基础结构\n  const $dropdown = $(`<div id=\"${DROPDOWN_ID}\"></div>`);\n  const $searchWrapper = $(\n    `<div class=\"search-wrapper\"><input type=\"text\" class=\"search-input\" placeholder=\"搜索…\" /></div>`,\n  );\n  const $optionsList = $(`<div class=\"options-list\"></div>`);\n  const $noResults = $(`<div class=\"no-results\">无结果</div>`);\n\n  const $searchInput = $searchWrapper.find('input');\n  const options = $select.find('option');\n\n  // 2. 构建选项列表 (使用 DocumentFragment 优化插入性能)\n  const items: JQuery<HTMLElement>[] = [];\n\n  options.each((_: number, opt: HTMLElement) => {\n    const $opt = $(opt);\n    if ($opt.css('display') === 'none') return;\n\n    const text = $opt.text();\n    const isSelected = $opt.is(':selected');\n\n    const $item = $(`<div class=\"option-item ${isSelected ? 'selected' : ''}\">${text}</div>`);\n\n    // 性能关键：将搜索用的文本存入 data 属性\n    $item.data('search-text', text.toLowerCase());\n\n    $item.on('click', e => {\n      // 阻止冒泡，防止触发 document 点击关闭，但我们需要先处理逻辑再关闭\n      e.stopPropagation();\n      $select.val($opt.val() ?? 'undefined');\n      $select.trigger('change');\n      closeDropdown();\n    });\n    // 防止在 item 上按下鼠标时触发 document 的关闭逻辑\n    $item.on('mousedown touchstart touchend', e => e.stopPropagation());\n\n    items.push($item);\n  });\n\n  $optionsList.append(items);\n  $optionsList.append($noResults);\n  $dropdown.append($searchWrapper).append($optionsList);\n  $('body').append($dropdown);\n\n  // 3. 搜索过滤逻辑\n  $searchInput.on(\n    'input',\n    debounce((e: any) => {\n      const val = e.target.value.toLowerCase().trim();\n      let hasVisible = false;\n\n      items.forEach($item => {\n        const itemText = $item.data('search-text');\n        if (!val || itemText.includes(val)) {\n          $item.css('display', '');\n          hasVisible = true;\n        } else {\n          $item.css('display', 'none');\n        }\n      });\n\n      if (hasVisible) {\n        $noResults.hide();\n      } else {\n        $noResults.show();\n      }\n    }, 200),\n  );\n\n  // 防止点击输入框导致 dropdown 关闭\n  $searchInput.on('mousedown click touchstart touchend', e => e.stopPropagation());\n\n  // 4. 定位计算\n  const rect = $select[0].getBoundingClientRect();\n  const scrollTop = $(window).scrollTop() || 0;\n  const scrollLeft = $(window).scrollLeft() || 0;\n  const windowHeight = $(window).height() || 0;\n\n  const estimatedMaxHeight = 350;\n  const spaceBelow = windowHeight - rect.bottom;\n\n  let top = 0;\n  if (spaceBelow < estimatedMaxHeight && rect.top > estimatedMaxHeight) {\n    // 向上展开\n    const actualHeight = $dropdown.outerHeight() ?? 300;\n    top = rect.top + scrollTop - actualHeight - 4;\n  } else {\n    // 向下展开\n    top = rect.bottom + scrollTop + 4;\n  }\n\n  const left = Math.max(4, rect.left + scrollLeft);\n\n  $dropdown.css({\n    top: top + 'px',\n    left: left + 'px',\n    minWidth: Math.max(rect.width, 200) + 'px',\n  });\n\n  // 5. 自动聚焦搜索框\n  setTimeout(() => {\n    $searchInput.trigger('focus');\n    const $selectedItem = $optionsList.find('.selected');\n    if ($selectedItem.length) {\n      $optionsList.scrollTop($selectedItem[0].offsetTop - $optionsList.height()! / 2);\n    }\n  }, 10);\n};\n\nconst init = () => {\n  injectGlobalStyles();\n  processSelects();\n\n  const observer = new MutationObserver(mutations => {\n    let needsProcess = false;\n    for (const mut of mutations) {\n      if (mut.addedNodes.length > 0) {\n        needsProcess = true;\n        break;\n      }\n    }\n    if (needsProcess) processSelects();\n  });\n\n  observer.observe(window.parent.document, { childList: true, subtree: true });\n};\n\n$(() => {\n  init();\n\n  window.parent.document.addEventListener('click', e => {\n    if (!e.target) return;\n    if ((e.target as Element).hasAttribute(REPLACED_MARKER)) return;\n    closeDropdown();\n  });\n});\n"],"names":["_","REPLACED_MARKER","ACTIVE_CLASS","DROPDOWN_ID","STYLE_ID","SCROLL_NAMESPACE","styles","closeDropdown","$activeSelect","$","length","parents","add","document","off","removeClass","remove","processSelects","not","each","$select","this","attr","on","e","button","preventDefault","focus","hasClass","openDropdown","key","stopPropagation","isActive","addClass","$dropdown","$searchWrapper","$optionsList","$noResults","$searchInput","find","options","items","opt","$opt","css","text","isSelected","is","$item","data","toLowerCase","val","trigger","push","append","debounce","target","value","trim","hasVisible","forEach","itemText","includes","hide","show","rect","getBoundingClientRect","scrollTop","window","scrollLeft","top","height","bottom","actualHeight","outerHeight","left","Math","max","minWidth","width","setTimeout","$selectedItem","offsetTop","init","appendTo","MutationObserver","mutations","needsProcess","mut","addedNodes","observe","parent","childList","subtree","addEventListener","hasAttribute"],"sourceRoot":""}