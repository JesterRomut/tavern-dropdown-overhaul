{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"_\"","src://tavern_helper_template/src/下拉选项大修/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = _;","import { debounce } from 'lodash';\n\n/* eslint-disable better-tailwindcss/no-duplicate-classes */\n//const REPLACED_MARKER = 'k3rn-replaced';\nconst ACTIVE_CLASS = 'k3rn-dropdown-active';\nconst DROPDOWN_ID = 'k3rn-dropdown-global';\nconst STYLE_ID = `k3rn-dropdown-overhaul`;\nconst EVENT_NAMESPACE = 'k3rn-dropdown-overhaul';\nconst SCROLL_NAMESPACE = 'k3rn-dropdown-scroll';\n\nconst SEARCH_THRESHOLD = 7; // 7是完美的数字哦 阿门\n\nconst styles = `\n  #${DROPDOWN_ID} {\n      margin: 0;\n      position: fixed;\n      z-index: 99999;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.4);\n      max-height: 400px;\n      display: flex;\n      flex-direction: column;\n      background: var(--SmartThemeBlurTintColor, #1a1a1a);\n      color: var(--SmartThemeBodyColor, #eee);\n      border: 1px solid var(--SmartThemeBorderColor, #444);\n      border-radius: 4px;\n\n      overflow: hidden;\n      backdrop-filter: blur(8px);\n      -webkit-backdrop-filter: blur(8px);\n  }\n\n  #${DROPDOWN_ID} .search-wrapper {\n      padding: 8px;\n      background: rgba(0, 0, 0, 0.2);\n      border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n      flex-shrink: 0;\n  }\n\n  #${DROPDOWN_ID} .search-input {\n      width: 100%;\n      padding: 6px 8px;\n      border-radius: 4px;\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      background: rgba(0, 0, 0, 0.3);\n      color: inherit;\n      outline: none;\n      font-size: 0.9em;\n  }\n  #${DROPDOWN_ID} .search-input:focus {\n      border-color: var(--SmartThemeQuoteColor, #888);\n      background: rgba(0, 0, 0, 0.5);\n  }\n\n  #${DROPDOWN_ID} .options-list {\n      overflow-y: auto;\n      flex-grow: 1;\n      max-height: 300px;\n  }\n\n  #${DROPDOWN_ID} .options-list::-webkit-scrollbar {\n      width: 6px;\n  }\n  #${DROPDOWN_ID} .options-list::-webkit-scrollbar-thumb {\n      background: rgba(255, 255, 255, 0.2);\n      border-radius: 3px;\n  }\n\n  #${DROPDOWN_ID} .option-item {\n      padding: 8px 12px;\n      cursor: pointer;\n      transition: background 0.1s;\n  }\n  #${DROPDOWN_ID} .option-item:hover {\n      background: rgba(128,128,128,0.1);\n  }\n  #${DROPDOWN_ID} .option-item.selected {\n      background: rgba(128,128,128,0.2);\n      font-weight: bold;\n      border-left: 3px solid var(--SmartThemeQuoteColor, #888);\n  }\n  #${DROPDOWN_ID} .no-results {\n      padding: 12px;\n      text-align: center;\n      color: var(--SmartThemeBodyColor, #eee);\n      font-style: italic;\n      display: none;\n  }\n  #${DROPDOWN_ID} .optgroup-header {\n      padding: 3px 12px;\n      font-size: 0.8em;\n      color: var(--SmartThemeQuoteColor, #888);\n      pointer-events: none;\n      background: rgba(128, 128, 128, 0.2);\n  }\n  #${DROPDOWN_ID} .option-item.grouped {\n      padding-left: 24px;\n  }\n`;\n\nconst injectGlobalStyles = () => {\n  $(`#${STYLE_ID}`).remove();\n  $(`<style id=\"${STYLE_ID}\">${styles}</style>`).appendTo('head');\n};\n\nconst closeDropdown = () => {\n  const $activeSelect = $(`.${ACTIVE_CLASS}`);\n  if ($activeSelect.length) {\n    $activeSelect.parents().add(document).off(`.${SCROLL_NAMESPACE}`);\n    $activeSelect.removeClass(ACTIVE_CLASS);\n  }\n  $(`#${DROPDOWN_ID}`).remove();\n};\n\nconst isMobile = () => Math.min(window.screen.width, window.outerWidth) <= 500;\n\nconst openDropdown = ($select: JQuery<HTMLElement>) => {\n  $select.addClass(ACTIVE_CLASS);\n\n  const $parents = $select.parents().add(document);\n  $parents.on(`scroll.${EVENT_NAMESPACE}`, () => {\n    closeDropdown();\n  });\n\n  //const options = $select.find('option');\n  const items: JQuery<HTMLElement>[] = [];\n  let validOptionCount = 0;\n  // 抽离出来的单个 Option 处理逻辑\n  const processOption = ($opt: JQuery<HTMLElement>, $groupHeader?: JQuery<HTMLElement>) => {\n    if ($opt.css('display') === 'none') return;\n    validOptionCount++;\n    const text = $opt.text();\n    const isSelected = $opt.is(':selected');\n    const groupedClass = $groupHeader ? 'grouped' : '';\n    const $item = $(`<div class=\"option-item ${groupedClass} ${isSelected ? 'selected' : ''}\">${text}</div>`);\n    // 记录元数据供搜索用\n    $item.data('type', 'option');\n    $item.data('search-text', text.toLowerCase());\n    if ($groupHeader) {\n      $item.data('group-header', $groupHeader);\n    }\n    $item.on('click', e => {\n      e.stopPropagation();\n      const value = $opt.val() ?? 'undefined';\n      const nativeSelect = $select[0] as HTMLSelectElement; // 这里采用native\n      nativeSelect.value = value.toString();\n      nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));\n      nativeSelect.dispatchEvent(new Event('input', { bubbles: true }));\n      $select.trigger('change');\n      $opt.trigger('click');\n      closeDropdown();\n    });\n    $item.on('mousedown touchstart touchend', e => e.stopPropagation());\n    items.push($item);\n  };\n\n  // 1. 构建选项列表，支持 optgroup 渲染\n  $select.children().each((_, child) => {\n    const $child = $(child);\n    if (child.tagName.toLowerCase() === 'optgroup') {\n      const label = $child.attr('label') || '';\n      const $groupHeader = $(`<div class=\"optgroup-header\">${label}</div>`);\n      $groupHeader.data('type', 'optgroup');\n\n      items.push($groupHeader);\n      const countBefore = validOptionCount;\n      $child.children('option').each((_, opt) => processOption($(opt), $groupHeader));\n\n      if (validOptionCount === countBefore) {\n        items.pop();\n      }\n      return;\n    }\n    processOption($child);\n  });\n\n  const search = validOptionCount > SEARCH_THRESHOLD;\n\n  const $dropdown = $(`<div id=\"${DROPDOWN_ID}\"></div>`);\n  const $optionsList = $(`<div class=\"options-list\"></div>`);\n  const $noResults = $(`<div class=\"no-results\">无结果</div>`);\n\n  //let $searchInput: JQuery<HTMLElement> | undefined;\n\n  // 3. 条件组装 DOM 结构\n  if (search) {\n    const $searchWrapper = $(\n      `<div class=\"search-wrapper\"><input type=\"text\" class=\"search-input\" placeholder=\"搜索…\" /></div>`,\n    );\n    const $searchInput = $searchWrapper.find('input');\n\n    // 搜索过滤逻辑 (仅在有搜索框时绑定)\n    $searchInput.on(\n      'input',\n      debounce((e: any) => {\n        const val = e.target.value.toLowerCase().trim();\n        let somethingsHere = false;\n\n        items.forEach($item => {\n          if ($item.data('type') === 'optgroup') {\n            $item.css('display', val ? 'none' : '');\n            return;\n          }\n          const itemText = $item.data('search-text');\n          if (!val || itemText.includes(val)) {\n            $item.css('display', '');\n            somethingsHere = true;\n\n            // 搜索命中时，同步将该选项对应的组标题展示出来\n            if (val) {\n              const $gh = $item.data('group-header');\n              if ($gh) $gh.css('display', '');\n            }\n          } else {\n            $item.css('display', 'none');\n          }\n        });\n\n        if (somethingsHere) {\n          $noResults.hide();\n        } else {\n          $noResults.show();\n        }\n      }, 200),\n    );\n\n    $searchInput.on('mousedown click touchstart touchend', e => e.stopPropagation());\n    $dropdown.append($searchWrapper);\n\n    setTimeout(() => {\n      if (isMobile()) return;\n      $searchInput[0].focus();\n      $searchInput.trigger('focus');\n    }, 6);\n  }\n\n  $optionsList.append(items).append($noResults);\n  $dropdown.append($optionsList);\n  //$('body').append($dropdown);\n\n  const $dialog = $select.closest('dialog');\n  if ($dialog.length) {\n    $dialog.append($dropdown);\n  } else {\n    $('body').append($dropdown);\n  }\n\n  // 4. 定位计算\n  const rect = $select[0].getBoundingClientRect();\n  const scrollTop = $(window).scrollTop() || 0;\n  const scrollLeft = $(window).scrollLeft() || 0;\n  const windowHeight = $(window).height() || 0;\n\n  const estimatedMaxHeight = 350;\n  const spaceBelow = windowHeight - rect.bottom;\n\n  let top = 0;\n  if (spaceBelow < estimatedMaxHeight && rect.top > estimatedMaxHeight) {\n    const actualHeight = $dropdown.outerHeight() ?? 300;\n    top = rect.top + scrollTop - actualHeight - 4;\n  } else {\n    top = rect.bottom + scrollTop + 4;\n  }\n\n  const left = Math.max(4, rect.left + scrollLeft);\n\n  $dropdown.css({\n    top: top + 'px',\n    left: left + 'px',\n    minWidth: Math.max(rect.width, 200) + 'px',\n  });\n\n  setTimeout(() => {\n    const $selectedItem = $optionsList.find('.selected');\n    if ($selectedItem.length) {\n      $optionsList.scrollTop($selectedItem[0].offsetTop - $optionsList.height()! / 2); //滚一滚\n    }\n  }, 7); //依旧7是最完美的数字\n};\n\nconst handleSelectTrigger = (e: JQuery.TriggeredEvent) => {\n  // 确保是左键\n  if (e.button !== 0) return;\n  const target = e.currentTarget as HTMLElement;\n  const $select = $(target);\n\n  e.preventDefault();\n  e.stopPropagation();\n\n  // 聚焦（为了保持键盘操作连贯性）\n  //target.focus();\n  const isActive = $select.hasClass(ACTIVE_CLASS);\n  if (isActive) {\n    closeDropdown();\n    return;\n  }\n  closeDropdown();\n  openDropdown($select);\n};\n\n// 使用事件委托\nconst init = () => {\n  injectGlobalStyles();\n  const targetDoc = window.parent.document || document;\n  $(targetDoc).on(`mousedown.${EVENT_NAMESPACE}`, 'select', handleSelectTrigger);\n\n  $(targetDoc).on(`click.${EVENT_NAMESPACE}`, 'select', e => {\n    e.preventDefault();\n    // 如果 mousedown 没触发（极少见），可以在这里补救，但通常只需 preventDefault\n  });\n\n  // 键盘事件也可以委托\n  $(targetDoc).on(`keydown.${EVENT_NAMESPACE}`, 'select', function (e) {\n    const $select = $(this);\n    if (e.key === ' ' || e.key === 'Enter') {\n      e.preventDefault();\n      e.stopPropagation();\n      const isActive = $select.hasClass(ACTIVE_CLASS);\n      closeDropdown();\n      if (!isActive) openDropdown($select);\n    }\n  });\n\n  $(targetDoc).on(`click.${EVENT_NAMESPACE}`, e => {\n    if (!e.target) return;\n    if ((e.target as any).closest('select')?.length ?? -1 > 0) return;\n    closeDropdown();\n  });\n};\n\nconst cleanup = () => {\n  const doc = window.parent.document || document;\n\n  closeDropdown();\n  $(`#${STYLE_ID}`).remove();\n  $(doc).off(`.${EVENT_NAMESPACE}`);\n\n  $(`.${ACTIVE_CLASS}`).removeClass(ACTIVE_CLASS);\n};\n\n$(() => init);\n$(window).on('pagehide', cleanup);\n"],"names":["_","ACTIVE_CLASS","DROPDOWN_ID","STYLE_ID","EVENT_NAMESPACE","styles","closeDropdown","$activeSelect","$","length","parents","add","document","off","removeClass","remove","openDropdown","$select","addClass","on","items","validOptionCount","processOption","$opt","$groupHeader","css","text","isSelected","is","$item","data","toLowerCase","e","stopPropagation","value","val","nativeSelect","toString","dispatchEvent","Event","bubbles","trigger","push","children","each","child","$child","tagName","label","attr","countBefore","opt","pop","search","$dropdown","$optionsList","$noResults","$searchWrapper","$searchInput","find","debounce","target","trim","somethingsHere","forEach","itemText","includes","$gh","hide","show","append","setTimeout","Math","min","window","screen","width","outerWidth","focus","$dialog","closest","rect","getBoundingClientRect","scrollTop","scrollLeft","top","height","bottom","actualHeight","outerHeight","left","max","minWidth","$selectedItem","offsetTop","handleSelectTrigger","button","currentTarget","preventDefault","hasClass","init","appendTo","targetDoc","parent","this","key","isActive","doc"],"sourceRoot":""}