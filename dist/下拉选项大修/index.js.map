{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"_\"","src://tavern_helper_template/src/下拉选项大修/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = _;","import { debounce } from 'lodash';\n\n/* eslint-disable better-tailwindcss/no-duplicate-classes */\nconst REPLACED_MARKER = 'k3rn-replaced';\nconst TRIGGER_ACTIVE_CLASS = 'k3rn-trigger-active'; // 激活状态类\nconst DROPDOWN_ID = 'k3rn-global-dropdown';\nconst STYLE_ID = `k3rn-select-style`;\nconst SCROLL_NAMESPACE = 'k3rn-select-scroll'; // 用于滚动事件的命名空间\n\n// 1. 样式定义\nconst styles = `\n  #${DROPDOWN_ID} {\n      position: absolute;\n      z-index: 99999;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.4);\n      max-height: 400px;\n      display: flex;\n      flex-direction: column;\n      background: var(--SmartThemeBorderColor, #1a1a1a);\n      color: var(--SmartThemeTextColor, #eee);\n      border: 1px solid var(--SmartThemeBorderColor, #444);\n      border-radius: 4px;\n      font-size: 14px;\n      overflow: hidden;\n  }\n\n  #${DROPDOWN_ID} .search-wrapper {\n      padding: 8px;\n      background: rgba(0, 0, 0, 0.2);\n      border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n      flex-shrink: 0;\n  }\n\n  #${DROPDOWN_ID} .search-input {\n      width: 100%;\n      padding: 6px 8px;\n      border-radius: 4px;\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      background: rgba(0, 0, 0, 0.3);\n      color: inherit;\n      outline: none;\n      font-size: 13px;\n  }\n  #${DROPDOWN_ID} .search-input:focus {\n      border-color: var(--SmartThemeQuoteColor, #888);\n      background: rgba(0, 0, 0, 0.5);\n  }\n\n  #${DROPDOWN_ID} .options-list {\n      overflow-y: auto;\n      flex-grow: 1;\n      max-height: 300px;\n  }\n\n  #${DROPDOWN_ID} .options-list::-webkit-scrollbar {\n      width: 6px;\n  }\n  #${DROPDOWN_ID} .options-list::-webkit-scrollbar-thumb {\n      background: rgba(255, 255, 255, 0.2);\n      border-radius: 3px;\n  }\n\n  #${DROPDOWN_ID} .option-item {\n      padding: 8px 12px;\n      cursor: pointer;\n      transition: background 0.1s;\n  }\n  #${DROPDOWN_ID} .option-item:hover {\n      background: rgba(255,255,255,0.1);\n  }\n  #${DROPDOWN_ID} .option-item.selected {\n      background: rgba(255,255,255,0.15);\n      font-weight: bold;\n      border-left: 3px solid var(--SmartThemeQuoteColor, #888);\n  }\n  #${DROPDOWN_ID} .no-results {\n      padding: 12px;\n      text-align: center;\n      color: rgba(255, 255, 255, 0.5);\n      font-style: italic;\n      display: none;\n  }\n`;\n\nfunction injectGlobalStyles() {\n  $(`#${STYLE_ID}`).remove();\n  $(`<style id=\"${STYLE_ID}\">${styles}</style>`).appendTo('head');\n}\n\nconst init = () => {\n  injectGlobalStyles();\n\n  const closeDropdown = () => {\n    // 1. 先处理事件清理：找到当前激活的 select\n    const $activeSelect = $(`.${TRIGGER_ACTIVE_CLASS}`);\n    if ($activeSelect.length) {\n      // 移除该 select 所有父级元素上的滚动监听，避免内存泄漏和不必要的触发\n      // add(window) 确保同时也移除了 window 上的监听\n      $activeSelect.parents().add(document).off(`.${SCROLL_NAMESPACE}`);\n      $activeSelect.removeClass(TRIGGER_ACTIVE_CLASS);\n    }\n\n    // 2. 移除 DOM\n    $(`#${DROPDOWN_ID}`).remove();\n  };\n\n  const processSelects = () => {\n    $('select')\n      .not(`[${REPLACED_MARKER}]`)\n      .each(function () {\n        const $select = $(this);\n        $select.attr(REPLACED_MARKER, 'true');\n\n        $select.on('mousedown', function (e) {\n          if (e.button !== 0) return;\n\n          e.preventDefault();\n          e.stopPropagation(); // 阻止冒泡，防止触发 document 的关闭事件\n          this.focus();\n\n          const isActive = $select.hasClass(TRIGGER_ACTIVE_CLASS);\n\n          // 如果已经打开，再次点击则是关闭\n          if (isActive) {\n            closeDropdown();\n            return;\n          }\n\n          // 关闭其他可能存在的下拉\n          closeDropdown();\n\n          openDropdown($select);\n        });\n\n        $select.on('keydown', function (e) {\n          if (e.key === ' ' || e.key === 'Enter') {\n            e.preventDefault();\n            e.stopPropagation();\n            const isActive = $select.hasClass(TRIGGER_ACTIVE_CLASS);\n            closeDropdown();\n            if (!isActive) openDropdown($select);\n          }\n        });\n      });\n  };\n\n  const openDropdown = ($select: JQuery<HTMLElement>) => {\n    $select.addClass(TRIGGER_ACTIVE_CLASS);\n\n    // --- 新增功能：监听父级滚动 ---\n    // 获取当前 select 的所有父级元素以及 window\n    // 当父容器滚动时，下拉菜单位置会错位，因此需要关闭菜单\n    const $parents = $select.parents().add(document);\n    $parents.on(`scroll.${SCROLL_NAMESPACE}`, () => {\n      closeDropdown();\n    });\n    // ---------------------------\n\n    // 1. 构建基础结构\n    const $dropdown = $(`<div id=\"${DROPDOWN_ID}\"></div>`);\n    const $searchWrapper = $(\n      `<div class=\"search-wrapper\"><input type=\"text\" class=\"search-input\" placeholder=\"搜索…\" /></div>`,\n    );\n    const $optionsList = $(`<div class=\"options-list\"></div>`);\n    const $noResults = $(`<div class=\"no-results\">无结果</div>`);\n\n    const $searchInput = $searchWrapper.find('input');\n    const options = $select.find('option');\n\n    // 2. 构建选项列表 (使用 DocumentFragment 优化插入性能)\n    const items: JQuery<HTMLElement>[] = [];\n\n    options.each((_: number, opt: HTMLElement) => {\n      const $opt = $(opt);\n      if ($opt.css('display') === 'none') return;\n\n      const text = $opt.text();\n      const isSelected = $opt.is(':selected');\n\n      const $item = $(`<div class=\"option-item ${isSelected ? 'selected' : ''}\">${text}</div>`);\n\n      // 性能关键：将搜索用的文本存入 data 属性\n      $item.data('search-text', text.toLowerCase());\n\n      $item.on('click', e => {\n        // 阻止冒泡，防止触发 document 点击关闭，但我们需要先处理逻辑再关闭\n        e.stopPropagation();\n        $select.val($opt.val() ?? 'undefined');\n        $select.trigger('change');\n        closeDropdown();\n      });\n      // 防止在 item 上按下鼠标时触发 document 的关闭逻辑\n      $item.on('mousedown touchstart touchend', e => e.stopPropagation());\n\n      items.push($item);\n    });\n\n    $optionsList.append(items);\n    $optionsList.append($noResults);\n    $dropdown.append($searchWrapper).append($optionsList);\n    $('body').append($dropdown);\n\n    // 3. 搜索过滤逻辑\n    $searchInput.on(\n      'input',\n      debounce((e: any) => {\n        const val = e.target.value.toLowerCase().trim();\n        let hasVisible = false;\n\n        items.forEach($item => {\n          const itemText = $item.data('search-text');\n          if (!val || itemText.includes(val)) {\n            $item.css('display', '');\n            hasVisible = true;\n          } else {\n            $item.css('display', 'none');\n          }\n        });\n\n        if (hasVisible) {\n          $noResults.hide();\n        } else {\n          $noResults.show();\n        }\n      }, 200),\n    );\n\n    // 防止点击输入框导致 dropdown 关闭\n    $searchInput.on('mousedown click touchstart touchend', e => e.stopPropagation());\n\n    // 4. 定位计算\n    const rect = $select[0].getBoundingClientRect();\n    const scrollTop = $(window).scrollTop() || 0;\n    const scrollLeft = $(window).scrollLeft() || 0;\n    const windowHeight = $(window).height() || 0;\n\n    const estimatedMaxHeight = 350;\n    const spaceBelow = windowHeight - rect.bottom;\n\n    let top = 0;\n    if (spaceBelow < estimatedMaxHeight && rect.top > estimatedMaxHeight) {\n      // 向上展开\n      const actualHeight = $dropdown.outerHeight() ?? 300;\n      top = rect.top + scrollTop - actualHeight - 4;\n    } else {\n      // 向下展开\n      top = rect.bottom + scrollTop + 4;\n    }\n\n    const left = Math.max(4, rect.left + scrollLeft);\n\n    $dropdown.css({\n      top: top + 'px',\n      left: left + 'px',\n      minWidth: Math.max(rect.width, 200) + 'px',\n    });\n\n    // 5. 自动聚焦搜索框\n    setTimeout(() => {\n      $searchInput.trigger('focus');\n      const $selectedItem = $optionsList.find('.selected');\n      if ($selectedItem.length) {\n        $optionsList.scrollTop($selectedItem[0].offsetTop - $optionsList.height()! / 2);\n      }\n    }, 10);\n  };\n\n  // 全局点击关闭\n  // 使用 document 而不是 window，兼容性更好\n  $(document).on('mousedown', () => {\n    // 这里的逻辑是：\n    // Trigger 的 mousedown 阻止了冒泡，不会到这里\n    // Dropdown 内部的 mousedown 也阻止了冒泡，不会到这里\n    // 所以只要代码执行到这里，说明点击在了外部\n    closeDropdown();\n  });\n\n  processSelects();\n\n  const observer = new MutationObserver(mutations => {\n    let needsProcess = false;\n    for (const mut of mutations) {\n      if (mut.addedNodes.length > 0) {\n        needsProcess = true;\n        break;\n      }\n    }\n    if (needsProcess) processSelects();\n  });\n\n  observer.observe(document.body, { childList: true, subtree: true });\n};\n\n$(() => {\n  init();\n});\n"],"names":["_","REPLACED_MARKER","TRIGGER_ACTIVE_CLASS","DROPDOWN_ID","STYLE_ID","SCROLL_NAMESPACE","styles","init","$","remove","appendTo","closeDropdown","$activeSelect","length","parents","add","document","off","removeClass","processSelects","not","each","$select","this","attr","on","e","button","preventDefault","stopPropagation","focus","hasClass","openDropdown","key","isActive","addClass","$dropdown","$searchWrapper","$optionsList","$noResults","$searchInput","find","options","items","opt","$opt","css","text","isSelected","is","$item","data","toLowerCase","val","trigger","push","append","debounce","target","value","trim","hasVisible","forEach","itemText","includes","hide","show","rect","getBoundingClientRect","scrollTop","window","scrollLeft","top","height","bottom","actualHeight","outerHeight","left","Math","max","minWidth","width","setTimeout","$selectedItem","offsetTop","MutationObserver","mutations","needsProcess","mut","addedNodes","observe","body","childList","subtree"],"sourceRoot":""}